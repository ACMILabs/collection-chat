<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACMI collection chat</title>
    <link href="{{ url_for('static', path='/styles.css') }}" rel="stylesheet">
    <meta id="results" data-name="results" data-results="{{results}}">
    <meta id="query" data-name="query" data-query="{{query}}">
</head>
<body>
    <h1><a href="/?json=false" title="Take me home">Show me something</a></h1>

    <form>
        <input type="text" name="query" id="query" placeholder="{% if query %}{% else %}Type your own question{% endif %}" value="{% if query %}{{ query }}{% endif %}">
        <input type="hidden" name="json" id="json" value="false">
    </form>

    <ol id="chats">
    </ol>
    <audio controls>
        <source src="{{ url_for('static', path='/audio/seb-are-you-looking-for-something.mp3') }}" type="audio/mp3">
    </audio>

    <h2>or</h2>

    <form onsubmit="mergeSelectionsAndSubmit(event)">
        {% for option in options %}
        <label for="items">{{ option.title }}</label>
        <select id="items" name="items" onchange="mergeSelectionsAndSubmit(event)">
            {% for value in option.options %}
            <option value="{{ value.0 }}" {% if value.1 %}selected{% endif %}>{{ value.0 }}</option>
            {% endfor %}
        </select>
        {% endfor %}
        <input type="submit" value="Show me">
        <input type="hidden" name="json" id="json" value="false">
    </form>

    <h2>or</h2>

    <form>
        <input type="submit" value="Let me suggest something for you">
        <input type="hidden" name="json" id="json" value="false">
        <input type="hidden" name="random" id="random" value="true">
    </form>

    <ul>
        {% for result in results %}
        <li>
            <h3><a href="https://url.acmi.net.au/w/{{ result.id }}" target="_blank">{{ result.title }}</a></h3>
            <p>{{ result.creator_credit }}</p>
            <p>{{ result.headline_credit }}</p>
            {{ result.brief_description|truncate(200)|safe }}
        </li>
        {% endfor %}
    </ul>

    <a href="https://www.acmi.net.au"><img class="logo" src="{{ url_for('static', path='/images/acmi-logo.svg') }}" alt="An ACMI labs experiment" title="An ACMI labs experiment" /></a>
    <p class="disclaimer">All answers are generated by a large language model, {{ model }}, so please use them with caution.</p>

    <script>
        var hasPlayed = false;
        /* Merges all select items into a single comma separated items URL parameter. */
        function mergeSelectionsAndSubmit(event) {
            event.preventDefault();
            const selections = Array.from(document.querySelectorAll('select[name="items"]'))
                                    .map(select => select.value);
            const mergedSelections = selections.join(',');
            const params = new URLSearchParams();
            params.append('items', mergedSelections);
            params.append('json', 'false');
            window.location.search = params.toString();
        }

        var results = document.getElementById('results').dataset.results;
        var query = document.getElementById('query').dataset.query;

        /* Plays Seb's voice when visitors tap in the query field. */
        document.onclick = function(event) {
            var audio = document.getElementsByTagName('audio')[0];
            if (!hasPlayed && query === "" && event.target.type === 'text') {
                audio.play();
                hasPlayed = true;
            }
        }

        /* Play the chat when tapped. */
        var chats = document.getElementById('chats');
        chats.onclick = function(event) {
            var audio = document.getElementsByTagName('audio')[0];
            audio.play();
        }

        /* Summarises the results and speaks them to you. */
        if (results != "[]") {
            if (!query) {
                query = 'Show me a random selection of collection items.';
            }
            fetch('/summarise', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: `{"query": ${query}, "results": ${results}}`,
            })
            .then(response => response.json())
            .then(data => {
                console.log('Summary:', data);
                fetch('/speak', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: data.replace('ACMI', 'acmee'),
                })
                .then(response => response.arrayBuffer())
                .then(arrayBuffer => {
                    const blob = new Blob([arrayBuffer], { type: 'audio/mp3' });
                    const audioUrl = URL.createObjectURL(blob);

                    // Show the transcript
                    var chats = document.getElementById('chats');
                    var newChatItem = document.createElement('li');
                    newChatItem.textContent = data;
                    chats.appendChild(newChatItem);

                    // Set the audio source to the new URL and play it
                    const audioElement = document.querySelector('audio');
                    const sourceElement = audioElement.querySelector('source');
                    sourceElement.src = audioUrl;
                    audioElement.load();
                    audioElement.play();
                })
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    </script>
</body>
</html>
